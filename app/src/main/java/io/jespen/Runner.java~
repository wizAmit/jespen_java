/*
 * This source file was generated by the Gradle 'init' task
 */
package io.jespen;

import com.eclipsesource.json.JsonObject;
import io.jespen.lib.*;
import io.jespen.lib.handlers.Broadcast;
import io.jespen.lib.handlers.NodeV2;
import io.jespen.lib.rpc.RpcClient;
import io.jespen.lib.rpc.RpcServer;

import java.io.IOException;
import java.util.Scanner;
import java.util.concurrent.*;
import java.util.function.BiConsumer;

public class Runner {

    static BiConsumer<Message, Throwable> outConsumer = (message, ex) -> {
        if (ex != null) {
            System.err.println("outConsumer Exception: " + ex.getLocalizedMessage());
        }

        System.err.println("Outputting " + message);
        if (message == null) return;
        JsonObject res = new JsonObject()
                .add("src", message.headers().src())
                .add("dest", message.headers().dest())
                .add("body", message.payload().getJsonObject());
        System.out.println(res.toString());
    };

    static ExecutorService executor = Executors.newSingleThreadExecutor(new ThreadFactory() {
        @Override
        public Thread newThread(Runnable r) {
            Thread thread = new Thread(r);
            thread.setDaemon(true);
            return thread;
        }
    });

    static ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(2, new ThreadFactory() {
        @Override
        public Thread newThread(Runnable r) {
            Thread thread = new Thread(r);
            thread.setDaemon(true);
            return thread;
        }
    });

    static Executor rpcClntExecutor = CompletableFuture.delayedExecutor(300, TimeUnit.MILLISECONDS, scheduler);

    public static void main(String[] args) throws IOException {

//        NodeV2 messageHandler = new EchoNodeV2();
//        NodeV2 messageHandler = new UniqIdNode();
        NodeV2 messageHandler = new Broadcast();
        CompletableFuture<Void> rpcSrvr = null;
        CompletableFuture<Void> rpcClnt = null;



        try (Scanner scanner = new Scanner(System.in)) {

            while (scanner.hasNext()) {
                String line = scanner.nextLine();
                CompletableFuture<Message> resFuture = CompletableFuture
                        .supplyAsync(() -> new ReqBuilder(line).build());

                resFuture.thenApply(messageHandler::handle)
                        .whenComplete(outConsumer)
                        .join();

                rpcClnt = CompletableFuture
                        .runAsync(() -> {
                            RpcClient client = new RpcClient((Broadcast) messageHandler);
                            client.start();
                        }, rpcClntExecutor);

                rpcSrvr = CompletableFuture
                        .runAsync(() -> {
                            RpcServer server = new RpcServer((Broadcast) messageHandler);
                            server.start();
                        }, executor);


            }
            rpcClnt.join();
            rpcSrvr.join();
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            scheduler.shutdown();
            executor.shutdown();
        }

    }
}
